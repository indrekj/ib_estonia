#!/usr/bin/env ruby

require 'nokogiri'
require_relative './lib/trade'
require_relative './lib/stock_tax_report'
require_relative './lib/exchange_rate_fetcher'

unless ARGV[0]
  puts "Usage: ./start 2017.xml"
  exit 1
end

doc = File.open(ARGV[0]) { |f| Nokogiri::XML(f) }

exchange_rate_fetcher = ExchangeRateFetcher.new

stock_trades = doc.xpath("//TradeConfirm[@assetCategory='STK']")
  .map(&:attributes)
  .each do |record|
    record.each {|key, val| record[key] = val.value}
  end
  .reject do |record|
    # Not sure why these are even listed here. Only seen happening with frac
    # share after a reverse split.
    #
    # Rejecting reverse splits because we don't currently support them.
    record['transactionType'] == 'FracShare' ||
      record['transactionType'] == 'FracShareCancel'
  end
  .map do |record|
    Trade.new(
      date: record['settleDate'],
      type: record['buySell'],
      quantity: record['quantity'],
      price: record['price'],
      currency: record['currency'],
      symbol: record['symbol']
    )
  end
  .map do |trade|
    trade.with(
      currency: 'EUR',
      price: exchange_rate_fetcher.convert(
        amount: trade.price,
        from: trade.currency,
        to: 'EUR',
        date: trade.date
      )
    )
  end

report = StockTaxReport.new(stock_trades)
report.print
